name: scan-and-run

on:
  workflow_dispatch:
    inputs:
      agent:
        description: "Agent folder name under /agents (example: GrantFinder-001)"
        required: true
        default: "GrantFinder-001"

jobs:
  scan_and_run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout StegAgents
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi

      - name: Scan repo for lingering StegID / stegid references (prints file + line)
        run: |
          python scripts/scan_no_stegid.py

      # If you want this workflow to ALSO run an agent after passing scan,
      # keep this step. If your agent-runner differs, tell me your command and I’ll
      # regenerate this whole file accordingly.
      - name: Run agent (best-effort)
        env:
          AGENT: ${{ inputs.agent }}
        run: |
          set -euo pipefail
          echo "▶️ Running agent: ${AGENT}"
          if [ -f "src/main.py" ]; then
            python -m src.main --agent "${AGENT}" || python src/main.py --agent "${AGENT}" || true
          elif [ -f "src/agent_runner.py" ]; then
            python -m src.agent_runner --agent "${AGENT}" || python src/agent_runner.py --agent "${AGENT}" || true
          else
            echo "⚠️ No known runner found (src/main.py or src/agent_runner.py)."
            echo "Tell me your exact run command and I'll regenerate this workflow."
          fi
